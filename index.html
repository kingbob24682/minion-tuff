using UnityEngine;
using UnityEngine.SceneManagement;
using System.Collections;
using System.Collections.Generic;

public class BananaDashGame : MonoBehaviour
{
    // ================= PLAYER =================
    public Transform player;
    Rigidbody rb;
    CapsuleCollider col;

    public float forwardSpeed = 10f;
    public float laneDistance = 2.5f;
    public float jumpForce = 7f;
    public float slideDuration = 0.7f;

    int currentLane = 1; // 0 = left, 1 = middle, 2 = right
    bool isGrounded = true;
    bool isSliding = false;

    // ================= INPUT =================
    Vector2 touchStart;

    // ================= SPAWNING =================
    public GameObject obstaclePrefab;
    public GameObject bananaPrefab;
    public float spawnDistance = 40f;
    public float spawnRate = 2f;
    float spawnTimer;

    // ================= POOLING =================
    List<GameObject> obstaclePool = new List<GameObject>();
    List<GameObject> bananaPool = new List<GameObject>();
    int poolSize = 25;

    // ================= SCORE =================
    int score;
    int bananas;

    // ================= UI =================
    GUIStyle guiStyle;

    void Awake()
    {
        rb = player.GetComponent<Rigidbody>();
        col = player.GetComponent<CapsuleCollider>();
        rb.constraints = RigidbodyConstraints.FreezeRotation;

        for (int i = 0; i < poolSize; i++)
        {
            GameObject o = Instantiate(obstaclePrefab);
            o.SetActive(false);
            obstaclePool.Add(o);

            GameObject b = Instantiate(bananaPrefab);
            b.SetActive(false);
            bananaPool.Add(b);
        }

        guiStyle = new GUIStyle();
        guiStyle.fontSize = 32;
        guiStyle.normal.textColor = Color.white;
    }

    void Update()
    {
        MoveForward();
        HandleSwipeInput();
        MoveLane();
        SpawnLoop();
        UpdateScore();
    }

    // ================= MOVEMENT =================
    void MoveForward()
    {
        player.Translate(Vector3.forward * forwardSpeed * Time.deltaTime);
    }

    void MoveLane()
    {
        Vector3 target = new Vector3(
            (currentLane - 1) * laneDistance,
            player.position.y,
            player.position.z
        );

        player.position = Vector3.Lerp(
            player.position,
            target,
            Time.deltaTime * 10f
        );
    }

    // ================= INPUT =================
    void HandleSwipeInput()
    {
        if (Input.touchCount == 0) return;
        Touch touch = Input.GetTouch(0);

        if (touch.phase == TouchPhase.Began)
            touchStart = touch.position;

        if (touch.phase == TouchPhase.Ended)
        {
            Vector2 delta = touch.position - touchStart;

            if (Mathf.Abs(delta.x) > Mathf.Abs(delta.y))
            {
                currentLane = Mathf.Clamp(
                    currentLane + (delta.x > 0 ? 1 : -1),
                    0,
                    2
                );
            }
            else
            {
                if (delta.y > 0 && isGrounded)
                    Jump();
                else if (!isSliding)
                    StartCoroutine(Slide());
            }
        }
    }

    void Jump()
    {
        isGrounded = false;
        rb.velocity = Vector3.up * jumpForce;
    }

    IEnumerator Slide()
    {
        isSliding = true;
        col.height = 1f;
        yield return new WaitForSeconds(slideDuration);
        col.height = 2f;
        isSliding = false;
    }

    // ================= SPAWNING =================
    void SpawnLoop()
    {
        spawnTimer += Time.deltaTime;
        if (spawnTimer < spawnRate) return;
        spawnTimer = 0f;

        int lane = Random.Range(0, 3);
        Vector3 pos = new Vector3(
            (lane - 1) * laneDistance,
            0,
            player.position.z + spawnDistance
        );

        if (Random.value > 0.4f)
            ActivateFromPool(obstaclePool, pos);
        else
            ActivateFromPool(bananaPool, pos + Vector3.up);
    }

    void ActivateFromPool(List<GameObject> pool, Vector3 pos)
    {
        foreach (GameObject obj in pool)
        {
            if (!obj.activeInHierarchy)
            {
                obj.transform.position = pos;
                obj.SetActive(true);
                return;
            }
        }
    }

    // ================= COLLISIONS =================
    void OnCollisionEnter(Collision collision)
    {
        if (collision.gameObject.CompareTag("Ground"))
            isGrounded = true;

        if (collision.gameObject.CompareTag("Obstacle"))
            RestartGame();
    }

    void OnTriggerEnter(Collider other)
    {
        if (other.CompareTag("Banana"))
        {
            bananas++;
            other.gameObject.SetActive(false);
        }
    }

    // ================= SCORE =================
    void UpdateScore()
    {
        score = Mathf.Max(score, (int)player.position.z);
    }

    // ================= GAME =================
    void RestartGame()
    {
        SceneManager.LoadScene(SceneManager.GetActiveScene().buildIndex);
    }

    void OnGUI()
    {
        GUI.Label(new Rect(20, 20, 300, 40), "Score: " + score, guiStyle);
        GUI.Label(new Rect(20, 60, 300, 40), "Bananas: " + bananas, guiStyle);
    }
}
