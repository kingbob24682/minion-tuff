using UnityEngine;
using UnityEngine.SceneManagement;
using System.Collections;
using System.Collections.Generic;

public class BananaDashGame : MonoBehaviour
{
    // ================= PLAYER =================
    public Transform player;
    Rigidbody rb;
    CapsuleCollider col;

    public float forwardSpeed = 10f;
    public float laneDistance = 2.5f;
    public float jumpForce = 7f;
    public float slideTime = 0.7f;

    int lane = 1; // 0 left, 1 middle, 2 right
    bool grounded = true;
    bool sliding = false;

    // ================= INPUT =================
    Vector2 touchStart;

    // ================= SPAWNING =================
    public GameObject obstaclePrefab;
    public GameObject bananaPrefab;
    public float spawnDistance = 40f;
    public float spawnRate = 2f;
    float spawnTimer;

    // ================= POOLING =================
    List<GameObject> obstaclePool = new List<GameObject>();
    List<GameObject> bananaPool = new List<GameObject>();
    int poolSize = 20;

    // ================= SCORE =================
    int score;
    int bananas;

    // ================= UI =================
    GUIStyle style;

    void Awake()
    {
        rb = player.GetComponent<Rigidbody>();
        col = player.GetComponent<CapsuleCollider>();

        rb.constraints = RigidbodyConstraints.FreezeRotation;

        for (int i = 0; i < poolSize; i++)
        {
            GameObject o = Instantiate(obstaclePrefab);
            o.SetActive(false);
            obstaclePool.Add(o);

            GameObject b = Instantiate(bananaPrefab);
            b.SetActive(false);
            bananaPool.Add(b);
        }

        style = new GUIStyle();
        style.fontSize = 32;
        style.normal.textColor = Color.white;
    }

    void Update()
    {
        RunForward();
        HandleSwipe();
        MoveLane();
        SpawnObjects();
        UpdateScore();
    }

    // ================= MOVEMENT =================
    void RunForward()
    {
        player.Translate(Vector3.forward * forwardSpeed * Time.deltaTime);
    }

    void MoveLane()
    {
        Vector3 target = new Vector3((lane - 1) * laneDistance, player.position.y, player.position.z);
        player.position = Vector3.Lerp(player.position, target, Time.deltaTime * 10f);
    }

    // ================= INPUT =================
    void HandleSwipe()
    {
        if (Input.touchCount == 0) return;
        Touch t = Input.GetTouch(0);

        if (t.phase == TouchPhase.Began)
            touchStart = t.position;

        if (t.phase == TouchPhase.Ended)
        {
            Vector2 delta = t.position - touchStart;

            if (Mathf.Abs(delta.x) > Mathf.Abs(delta.y))
            {
                lane = Mathf.Clamp(lane + (delta.x > 0 ? 1 : -1), 0, 2);
            }
            else
            {
                if (delta.y > 0 && grounded)
                    Jump();
                else if (!sliding)
                    StartCoroutine(Slide());
            }
        }
    }

    void Jump()
    {
        grounded = false;
        rb.velocity = Vector3.up * jumpForce;
    }

    IEnumerator Slide()
    {
        sliding = true;
        col.height = 1f;
        yield return new WaitForSeconds(slideTime);
        col.height = 2f;
        sliding = false;
    }

    // ================= SPAWNING =================
    void SpawnObjects()
    {
        spawnTimer += Time.deltaTime;
        if (spawnTimer < spawnRate) return;
        spawnTimer = 0;

        int spawnLane = Random.Range(0, 3);
        Vector3 pos = new Vector3((spawnLane - 1) * laneDistance, 0, player.position.z + spawnDistance);

        if (Random.value > 0.4f)
            ActivateFromPool(obstaclePool, pos);
        else
            ActivateFromPool(bananaPool, pos + Vector3.up);
    }

    void ActivateFromPool(List<GameObject> pool, Vector3 pos)
    {
        foreach (GameObject obj in pool)
        {
            if (!obj.activeInHierarchy)
            {
                obj.transform.position = pos;
                obj.SetActive(true);
                return;
            }
        }
    }

    // ================= COLLISIONS =================
    void OnCollisionEnter(Collision c)
    {
        if (c.gameObject.CompareTag("Ground"))
            grounded = true;

        if (c.gameObject.CompareTag("Obstacle"))
            Restart();
    }

    void OnTriggerEnter(Collider c)
    {
        if (c.CompareTag("Banana"))
        {
            bananas++;
            c.gameObject.SetActive(false);
        }
    }

    // ================= SCORE =================
    void UpdateScore()
    {
        score = Mathf.Max(score, (int)player.position.z);
    }

    // ================= GAME =================
    void Restart()
    {
        SceneManager.LoadScene(SceneManager.GetActiveScene().buildIndex);
    }

    void OnGUI()
    {
        GUI.Label(new Rect(20, 20, 300, 40), "Score: " + score, style);
        GUI.Label(new Rect(20, 60, 300, 40), "Bananas: " + bananas, style);
    }
}

  
